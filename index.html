<!DOCTYPE html>
<html>
  <head>
    <style>
      #playground {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <canvas id="playground" width="500" height="200"></canvas>
    <script type="text/javascript">
      var canvas = document.getElementById("playground");
      var ctx = canvas.getContext('2d');
      var intervalID = null;
      var resourcesToLoad = 3;
      var isDead = false;
      var score = 0;
      var pipesDestroied = 0;
      var pipesPassedInScreen = 0;
      var KEYBOARD = {
        "UP"    : 38,
        "LEFT"  : 37,
        "DOWN"  : 40,
        "RIGHT" : 39 
      };

      var xSpaceBetweenPipe = 100;
      var ySpaceBetwwenPipe = 80;
      var pipes = [{x: 250, y: randomY()}, {x: 400, y: randomY()},{x: 550, y: randomY()},{x: 700, y: randomY()},{x: 850, y: randomY()}];

      var mario = new Image();
      mario.addEventListener("load", function () {
        resourcesToLoad--;
      });
      mario.src = "images/mario.png";
      mario.xPos = 0;
      mario.yPos = 85;
      mario.xSpeed = 0;
      mario.ySpeed = 0;

      var pipe = new Image();
      pipe.addEventListener("load", function () {
        resourcesToLoad--;
      });
      pipe.src = "images/pipe.png";

      var flySound = new Audio();
      flySound.autoplay = false;
      flySound.addEventListener("canplaythrough", function () {
        resourcesToLoad--;
      });
      flySound.src = "sounds/fly.wav";

      initOnResourcesLoad();

      function initOnResourcesLoad () {
        if (resourcesToLoad > 0) {
          setTimeout(initOnResourcesLoad, 50);
        }
        else {
          intervalID = setInterval(draw, 20);
        }
      }

      window.addEventListener("keydown", function (event) {
        if (event.keyCode === KEYBOARD.LEFT) {
          mario.xSpeed = -5;
        }
        else if (event.keyCode === KEYBOARD.RIGHT) {
          mario.xSpeed = 5;
        }
        else if (event.keyCode === KEYBOARD.UP) {
          flySound.play();
          mario.ySpeed = 5;
        }
      });

      window.addEventListener("keyup", function () {
        if (event.keyCode === KEYBOARD.LEFT) {
          mario.xSpeed = 0;
        }
        else if (event.keyCode === KEYBOARD.RIGHT) {
          mario.xSpeed = 0;
        }
      });

      function randomY () {
        return Math.floor(Math.random() * (200 - ySpaceBetwwenPipe)) + ySpaceBetwwenPipe / 2;
      }

      function draw () {
        pipesPassedInScreen = 0;
        ctx.clearRect(0,0,500,200);
        ctx.globalCompositeOperation = "destination-over";
        mario.xPos = mario.xPos + mario.xSpeed;
        mario.yPos = mario.yPos - mario.ySpeed;

        if (mario.xPos < 0) {
          mario.xPos = 0;
        }
        else if (mario.xPos >= 235) {
          mario.xPos = 235;
          pipes.forEach(function (pipePos) {
            pipePos.x -= 1;
          });

          if (pipes[0].x + 25 <= 0) {
            pipes.shift();
            pipes.push({x: pipes[pipes.length - 1].x + 150, y: randomY()});
            pipesDestroied++;
          }
        }
        else {
          mario.xPos += 1;
        }

        if (mario.yPos > 170) {
          mario.yPos = 170;
          mario.ySpeed = 0;
        }
        else if (mario.yPos < 0) {
          mario.yPos = 0;
          mario.ySpeed = 0;
        }
        else {
          mario.ySpeed -= 0.5;
        }

        ctx.font = "15pt Arial";
        ctx.fillText("Score: " + score, 10, 20);

        ctx.drawImage(mario, mario.xPos, mario.yPos, 30, 30);

        pipes.forEach(function (pipePos) {
          ctx.drawImage(pipe, (pipePos.x - 25), (pipePos.y + (ySpaceBetwwenPipe / 2)), 50, 154);
          ctx.save();
          ctx.scale(1, -1);
          ctx.drawImage(pipe, (pipePos.x - 25), -(pipePos.y - (ySpaceBetwwenPipe / 2)), 50, 154);
          ctx.restore();
        });

        //
        // Check if game is over
        //

        // when mario fall to the ground
        if (mario.yPos >= 170) {
          isDead = true;
        }

        // when mario hit one of the pipes
        pipes.forEach(function (pipePos) {
          if (mario.xPos > pipePos.x + 25 || mario.xPos + 30 < pipePos.x - 25) {
            if (mario.xPos > pipePos.x + 25) {
              pipesPassedInScreen++;
            }
            return;
          }
          else if ((mario.yPos > pipePos.y - (ySpaceBetwwenPipe / 2)) && (mario.yPos + 30 < pipePos.y + (ySpaceBetwwenPipe / 2))) {
            return;
          }
          else {
            isDead = true;
          }
        });

        score = pipesDestroied + pipesPassedInScreen;

        if (isDead) {
          clearInterval(intervalID);
          alert("GAME OVER\nFinal Score: " + score);
        }
      }
    </script>
  </body>
</html>